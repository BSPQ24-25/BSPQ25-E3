<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ItemController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">StudentLoanManagement</a> &gt; <a href="index.source.html" class="el_package">com.student_loan.controller</a> &gt; <span class="el_source">ItemController.java</span></div><h1>ItemController.java</h1><pre class="source lang-java linenums">package com.student_loan.controller;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.*;

import com.student_loan.dtos.ItemRecord;
import com.student_loan.model.Item;
import com.student_loan.model.User;
import com.student_loan.service.ItemService;
import com.student_loan.service.LoanService;
import com.student_loan.service.UserService;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

/**
 * Controller class for managing items in the system. Handles HTTP requests
 * related to item operations such as creating, updating, deleting, and
 * retrieving items.
 */
@RestController
@RequestMapping(&quot;/items&quot;)
public class ItemController {
	
<span class="fc" id="L32">    private static final Logger logger = LoggerFactory.getLogger(ItemController.class);</span>

    @Autowired
    private ItemService itemService;
    @Autowired
    private UserService userService;
	@Autowired
    private LoanService loanService;

	/**
	 * Constructor for ItemController.
	 *
	 * @param itemService Service for item operations.
	 * @param userService Service for user operations.
	 * @param loanService Service for loan operations.
	 */
	@Autowired
<span class="fc" id="L49">	public ItemController(ItemService itemService, UserService userService, LoanService loanService) {</span>
<span class="fc" id="L50">		this.itemService = itemService;</span>
<span class="fc" id="L51">		this.userService = userService;</span>
<span class="fc" id="L52">		this.loanService = loanService;</span>
<span class="fc" id="L53">	}</span>

	/**
	 * Retrieves the authenticated user from the SecurityContext.
	 *
	 * @return The authenticated user.
	 */
	private User getAuthenticatedUser() {
<span class="fc" id="L61">        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="fc" id="L62">        String email = authentication.getName();</span>
<span class="fc" id="L63">        return userService.getUserByEmail(email);</span>
    }

	/**
	 * Retrieves all items in the system.
	 *
	 * @return List of all items.
	 */
    @GetMapping
    public ResponseEntity&lt;List&lt;Item&gt;&gt; getAllItems() {
<span class="fc" id="L73">		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="fc" id="L74">		String email = authentication.getName();</span>

<span class="fc" id="L76">    	User user = userService.getUserByEmail(email);</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">        if (user == null) { // || user.getAdmin()==false) {  Temporal</span>
<span class="fc" id="L78">			return new ResponseEntity&lt;&gt;(new ArrayList&lt;&gt;(),HttpStatus.UNAUTHORIZED);</span>
        }
    	
<span class="fc" id="L81">    	return new ResponseEntity&lt;&gt;(itemService.getAllItems(),HttpStatus.OK);</span>
    }

    /**
     * Retrieves all available items in the system.
     *
     * @return ResponseEntity containing a list of available items.
     */

	@GetMapping(&quot;/available&quot;)
    public ResponseEntity&lt;List&lt;Item&gt;&gt; getAvailableItems() {
<span class="fc" id="L92">		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="fc" id="L93">		String email = authentication.getName();</span>

<span class="fc" id="L95">    	User user = userService.getUserByEmail(email);</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">        if (user == null) {</span>
<span class="fc" id="L97">			return new ResponseEntity&lt;&gt;(new ArrayList&lt;&gt;(),HttpStatus.UNAUTHORIZED);</span>
        }
    	
<span class="fc" id="L100">    	return new ResponseEntity&lt;&gt;(itemService.getAvailableItems(),HttpStatus.OK);</span>
    }

	 /**
     * Retrieves all items owned by a specific user.
     *
     * @param id The ID of the user.
     * @return ResponseEntity containing a list of items owned by the user.
     */
    @GetMapping(&quot;/user/{id}&quot;)
    public ResponseEntity&lt;List&lt;Item&gt;&gt; getItemsByUser(@PathVariable Long id) {
<span class="fc" id="L111">    	Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="fc" id="L112">		String email = authentication.getName();</span>

<span class="fc" id="L114">    	User user = userService.getUserByEmail(email);</span>
		
<span class="fc bfc" id="L116" title="All 2 branches covered.">        if (user == null) { // || (user.getAdmin()==false &amp;&amp; user.getId()!=id)) { TODO Uncomment to enable a user only to see its own items</span>
<span class="fc" id="L117">			return new ResponseEntity&lt;&gt;(HttpStatus.UNAUTHORIZED);</span>
        }else {
        	try {
<span class="fc" id="L120">    			List&lt;Item&gt; items = itemService.getItemsByUser(id);</span>
<span class="fc" id="L121">    			return new ResponseEntity&lt;&gt;(items, HttpStatus.OK);</span>
<span class="fc" id="L122">			} catch (RuntimeException e) {</span>
<span class="fc" id="L123">				return new ResponseEntity&lt;&gt;(HttpStatus.BAD_REQUEST);</span>
			}
        }
    }
    
    /**
     * Retrieves an item by its ID.
     *
     * @param id The ID of the item.
     * @return ResponseEntity containing the item.
     */
    @GetMapping(&quot;/{id}&quot;)
	public ResponseEntity&lt;Item&gt; getItemById(@PathVariable Long id) {
<span class="fc" id="L136">		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="fc" id="L137">		String email = authentication.getName();</span>

<span class="fc" id="L139">		User user = userService.getUserByEmail(email);</span>
<span class="fc" id="L140">		Optional&lt;Item&gt; optionalItem = itemService.getItemById(id);</span>

<span class="fc bfc" id="L142" title="All 4 branches covered.">		if (user == null || optionalItem.isEmpty()) {</span>
<span class="fc" id="L143">			return new ResponseEntity&lt;&gt;(HttpStatus.UNAUTHORIZED); // o 404 si prefieres</span>
		}

<span class="fc" id="L146">		Item item = optionalItem.get();</span>

<span class="fc bfc" id="L148" title="All 2 branches covered.">		if (!item.getOwner().equals(user.getId())) { // TODO &amp;&amp; !user.getAdmin()) {</span>
<span class="fc" id="L149">			return new ResponseEntity&lt;&gt;(HttpStatus.FORBIDDEN);</span>
		}

<span class="fc" id="L152">		return new ResponseEntity&lt;&gt;(item, HttpStatus.OK);</span>
	}
    
    /**
     * Retrieves all items lent by the authenticated user.
     *
     * @return ResponseEntity containing a list of lent items.
     */

	@GetMapping(&quot;/lent&quot;)
	public ResponseEntity&lt;List&lt;Item&gt;&gt; getLentItemsByUser() {
		// Obtener el usuario autenticado desde el SecurityContext
<span class="fc" id="L164">		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="fc" id="L165">		String email = authentication.getName(); // Usamos el email como identificador</span>

		// Buscar al usuario por el email
<span class="fc" id="L168">		User user = userService.getUserByEmail(email);</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">		if (user == null) {</span>
<span class="fc" id="L170">			return new ResponseEntity&lt;&gt;(HttpStatus.UNAUTHORIZED);</span>
		}

		try {
			// Obtener los items que el usuario ha prestado
<span class="fc" id="L175">			List&lt;Long&gt; lentItemsId = loanService.getLentItemsIdByUser(user.getId());</span>
<span class="fc" id="L176">			List&lt;Item&gt; lentItems = itemService.getItemsById(lentItemsId);</span>

<span class="fc" id="L178">			return new ResponseEntity&lt;&gt;(lentItems, HttpStatus.OK);</span>
<span class="fc" id="L179">		} catch (RuntimeException e) {</span>
			// Si ocurre un error, devolvemos un error 500
<span class="fc" id="L181">			return new ResponseEntity&lt;&gt;(HttpStatus.INTERNAL_SERVER_ERROR);</span>
		}
	}

	/**
     * Retrieves all items borrowed by the authenticated user.
     *
     * @return ResponseEntity containing a list of borrowed items.
     */
	@GetMapping(&quot;/borrowed&quot;)
	public ResponseEntity&lt;List&lt;Item&gt;&gt; getBorrowedItemsByUser() {
		// Obtener el usuario autenticado desde el SecurityContext
<span class="fc" id="L193">		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="fc" id="L194">		String email = authentication.getName(); // Usamos el email como identificador</span>

		// Buscar al usuario por el email
<span class="fc" id="L197">		User user = userService.getUserByEmail(email);</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">		if (user == null) {</span>
<span class="fc" id="L199">			return new ResponseEntity&lt;&gt;(HttpStatus.UNAUTHORIZED);</span>
		}

		try {
			// Obtener los items que el usuario ha prestado
<span class="fc" id="L204">			List&lt;Long&gt; lentItemsId = loanService.getBorrowedItemsIdByUser(user.getId());</span>
<span class="fc" id="L205">			List&lt;Item&gt; lentItems = itemService.getItemsById(lentItemsId);</span>

<span class="fc" id="L207">			return new ResponseEntity&lt;&gt;(lentItems, HttpStatus.OK);</span>
<span class="fc" id="L208">		} catch (RuntimeException e) {</span>
			// Si ocurre un error, devolvemos un error 500
<span class="fc" id="L210">			return new ResponseEntity&lt;&gt;(HttpStatus.INTERNAL_SERVER_ERROR);</span>
		}
	}

	 /**
     * Creates a new item.
     *
     * @param itemRecord The item data.
     * @return ResponseEntity indicating the result of the operation.
     */


    @PostMapping(&quot;/create&quot;)
    public ResponseEntity&lt;String&gt; createItem(@RequestBody ItemRecord itemRecord) {
<span class="fc" id="L224">        User user = getAuthenticatedUser();</span>
<span class="fc bfc" id="L225" title="All 2 branches covered."> 		if (user == null) {</span>
<span class="fc" id="L226"> 			return new ResponseEntity&lt;&gt;(HttpStatus.UNAUTHORIZED);</span>
 		}
 		
<span class="fc" id="L229"> 		Item item = convertToItem(itemRecord);</span>
<span class="fc" id="L230"> 		item.setOwner(user.getId());</span>
 		try {
<span class="fc" id="L232"> 			itemService.saveItem(item);</span>
<span class="fc" id="L233">        } catch (RuntimeException e) {</span>
<span class="fc" id="L234">             return new ResponseEntity&lt;&gt;(e.getMessage(), HttpStatus.BAD_REQUEST);</span>
<span class="fc" id="L235">         }</span>
 		// If the item is created successfully, return a 201 Created response
<span class="fc" id="L237"> 		return new ResponseEntity&lt;&gt;(HttpStatus.CREATED);</span>
    }

	

    /**
     * Creates a new item using a token for authentication.
     *
     * @param itemRecord The item data.
     * @param token      The authentication token.
     * @return ResponseEntity indicating the result of the operation.
     */
	@PostMapping(params = &quot;token&quot;)
     public ResponseEntity&lt;String&gt; createItem(@RequestBody ItemRecord itemRecord, @RequestParam(&quot;token&quot;) String token) {
<span class="fc" id="L251">         User user = userService.getUserByToken(token);</span>
<span class="fc bfc" id="L252" title="All 2 branches covered.">         if (user == null) {</span>
<span class="fc" id="L253">             return new ResponseEntity&lt;&gt;(HttpStatus.UNAUTHORIZED);</span>
         }
<span class="fc" id="L255">         Item item = convertToItem(itemRecord);</span>
<span class="fc" id="L256">         item.setOwner(user.getId());</span>
         try {
<span class="fc" id="L258">             itemService.saveItem(item);</span>
<span class="fc" id="L259">         } catch (RuntimeException e) {</span>
<span class="fc" id="L260">             return new ResponseEntity&lt;&gt;(e.getMessage(), HttpStatus.BAD_REQUEST);</span>
<span class="fc" id="L261">         }</span>
<span class="fc" id="L262">         return new ResponseEntity&lt;&gt;(HttpStatus.CREATED);</span>
     }

	
	 /**
     * Deletes an item by its ID.
     *
     * @param id    The ID of the item.
     * @param token The authentication token.
     * @return ResponseEntity indicating the result of the operation.
     */
	
    @DeleteMapping(&quot;/{id}&quot;)
    public ResponseEntity&lt;String&gt; deleteItem(@PathVariable Long id, @RequestParam(&quot;token&quot;) String token) {
<span class="fc" id="L276">        User user = userService.getUserByToken(token);</span>
<span class="fc bfc" id="L277" title="All 6 branches covered.">        if (user == null || user.getAdmin()==false &amp;&amp; user.getId()!=itemService.getItemById(id).get().getOwner()) {</span>
<span class="fc" id="L278">			return new ResponseEntity&lt;&gt;(HttpStatus.UNAUTHORIZED);</span>
		
        }
    	
<span class="fc" id="L282">    	itemService.deleteItem(id);</span>
<span class="fc" id="L283">    	return new ResponseEntity&lt;&gt;(HttpStatus.OK);</span>
    }
    
    /**
     * Updates an item by its ID.
     *
     * @param id       The ID of the item.
     * @param item     The updated item data.
     * @param token    The authentication token.
     * @return ResponseEntity indicating the result of the operation.
     */
    @PutMapping(&quot;/{id}&quot;)
	public ResponseEntity&lt;String&gt; updateItem(@PathVariable Long id, @RequestBody ItemRecord item, @RequestParam(&quot;token&quot;) String token) {
<span class="fc" id="L296">    	User user = userService.getUserByToken(token);</span>
<span class="fc bfc" id="L297" title="All 6 branches covered.">		if (user == null || user.getId()!=Long.valueOf(itemService.getItemById(id).get().getOwner()) &amp;&amp; user.getAdmin()!=true) {</span>
<span class="fc" id="L298">			return new ResponseEntity&lt;&gt;(HttpStatus.UNAUTHORIZED);</span>
		}
		
    	try {
<span class="fc" id="L302">    		Item itemToModify = itemService.getItemById(id).get();</span>
<span class="fc bfc" id="L303" title="All 2 branches covered.">			itemToModify.setName(item.name() == null ? itemToModify.getName() : item.name() );</span>
<span class="fc bfc" id="L304" title="All 2 branches covered.">			itemToModify.setDescription(item.description() == null ? itemToModify.getDescription() : item.description() );</span>
<span class="fc bfc" id="L305" title="All 2 branches covered.">			itemToModify.setCategory(item.category() == null ? itemToModify.getCategory() : item.category());</span>
<span class="fc bfc" id="L306" title="All 2 branches covered.">			itemToModify.setImage(item.imageUrl() == null ? itemToModify.getImage() : item.imageUrl());</span>
<span class="fc bfc" id="L307" title="All 2 branches covered.">			itemToModify.setStatus(Item.ItemStatus.valueOf(item.status()==null ? itemToModify.getStatus().toString() : item.status()));</span>
<span class="fc bfc" id="L308" title="All 2 branches covered.">			itemToModify.setCondition(Item.ItemCondition.valueOf(item.condition()==null ? itemToModify.getCondition().toString() : item.condition()));</span>
<span class="fc" id="L309">			itemService.saveItem(itemToModify);</span>
<span class="fc" id="L310">			return new ResponseEntity&lt;&gt;(HttpStatus.OK);</span>
<span class="fc" id="L311">		} catch (RuntimeException e) {</span>
<span class="fc" id="L312">			return new ResponseEntity&lt;&gt;(e.getMessage(),HttpStatus.NOT_FOUND);</span>
		}
	}

    /**
     * Converts an ItemRecord to an Item entity.
     *
     * @param itemRecord The item record.
     * @return The converted Item entity.
     */
    private Item convertToItem(ItemRecord itemRecord) {
<span class="fc" id="L323">		Item item = new Item();</span>
<span class="fc" id="L324">		item.setName(itemRecord.name());</span>
<span class="fc" id="L325">		item.setDescription(itemRecord.description());</span>
<span class="fc" id="L326">		item.setCategory(itemRecord.category());</span>
<span class="fc" id="L327">		item.setImage(itemRecord.imageUrl());</span>
<span class="fc" id="L328">		item.setStatus(Item.ItemStatus.valueOf(itemRecord.status().toUpperCase()));</span>
<span class="fc" id="L329">		item.setPurchaseDate(new java.util.Date());</span>
<span class="fc" id="L330">		item.setPurchasePrice(0.0);</span>
<span class="fc" id="L331">		item.setCondition(Item.ItemCondition.NEW);</span>
<span class="fc" id="L332">		return item;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>