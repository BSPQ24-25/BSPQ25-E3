<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ItemController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">StudentLoanManagement</a> &gt; <a href="index.source.html" class="el_package">com.student_loan.controller</a> &gt; <span class="el_source">ItemController.java</span></div><h1>ItemController.java</h1><pre class="source lang-java linenums">package com.student_loan.controller;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.*;

import com.student_loan.dtos.ItemRecord;
import com.student_loan.model.Item;
import com.student_loan.model.User;
import com.student_loan.service.ItemService;
import com.student_loan.service.LoanService;
import com.student_loan.service.UserService;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

/**
 * Controller class for managing items in the system. Handles HTTP requests
 * related to item operations such as creating, updating, deleting, and
 * retrieving items.
 */
@RestController
@RequestMapping(&quot;/items&quot;)
public class ItemController {
	
<span class="fc" id="L32">    private static final Logger logger = LoggerFactory.getLogger(ItemController.class);</span>

    @Autowired
    private ItemService itemService;
    @Autowired
    private UserService userService;
	@Autowired
    private LoanService loanService;

	/**
	 * Constructor for ItemController.
	 *
	 * @param itemService Service for item operations.
	 * @param userService Service for user operations.
	 * @param loanService Service for loan operations.
	 */
	@Autowired
<span class="fc" id="L49">	public ItemController(ItemService itemService, UserService userService, LoanService loanService) {</span>
<span class="fc" id="L50">		this.itemService = itemService;</span>
<span class="fc" id="L51">		this.userService = userService;</span>
<span class="fc" id="L52">		this.loanService = loanService;</span>
<span class="fc" id="L53">	}</span>

	/**
	 * Retrieves the authenticated user from the SecurityContext.
	 *
	 * @return The authenticated user.
	 */
	private User getAuthenticatedUser() {
<span class="fc" id="L61">        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="fc" id="L62">        String email = authentication.getName();</span>
<span class="fc" id="L63">        return userService.getUserByEmail(email);</span>
    }

	/**
	 * Retrieves all items in the system.
	 *
	 * @return List of all items.
	 */
    @GetMapping
    public ResponseEntity&lt;List&lt;Item&gt;&gt; getAllItems() {
<span class="fc" id="L73">		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="fc" id="L74">		String email = authentication.getName();</span>

<span class="fc" id="L76">    	User user = userService.getUserByEmail(email);</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">        if (user == null) { // || user.getAdmin()==false) {  Temporal</span>
<span class="fc" id="L78">			return new ResponseEntity&lt;&gt;(new ArrayList&lt;&gt;(),HttpStatus.UNAUTHORIZED);</span>
        }
    	
<span class="fc" id="L81">    	return new ResponseEntity&lt;&gt;(itemService.getAllItems(),HttpStatus.OK);</span>
    }

    /**
     * Retrieves all available items in the system.
     *
     * @return ResponseEntity containing a list of available items.
     * 
     *

     */
    
    @GetMapping(&quot;/available&quot;)
    public ResponseEntity&lt;List&lt;Item&gt;&gt; getAvailableItems() {
<span class="fc" id="L95">		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="fc" id="L96">		String email = authentication.getName();</span>

<span class="fc" id="L98">    	User user = userService.getUserByEmail(email);</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">        if (user == null) {</span>
<span class="fc" id="L100">			return new ResponseEntity&lt;&gt;(new ArrayList&lt;&gt;(),HttpStatus.UNAUTHORIZED);</span>
        }
    	
<span class="fc" id="L103">    	return new ResponseEntity&lt;&gt;(itemService.getAvailableItems(),HttpStatus.OK);</span>
    }

	
	 /**
     * Retrieves all items owned by a specific user.
     *
     * @param id The ID of the user.
     * @return ResponseEntity containing a list of items owned by the user.
     */
    @GetMapping(&quot;/user/{id}&quot;)
    public ResponseEntity&lt;List&lt;Item&gt;&gt; getItemsByUser(@PathVariable Long id) {
<span class="fc" id="L115">    	Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="fc" id="L116">		String email = authentication.getName();</span>

<span class="fc" id="L118">    	User user = userService.getUserByEmail(email);</span>
		
<span class="fc bfc" id="L120" title="All 2 branches covered.">        if (user == null) { // || (user.getAdmin()==false &amp;&amp; user.getId()!=id)) { TODO Uncomment to enable a user only to see its own items</span>
<span class="fc" id="L121">			return new ResponseEntity&lt;&gt;(HttpStatus.UNAUTHORIZED);</span>
        }else {
        	try {
<span class="fc" id="L124">    			List&lt;Item&gt; items = itemService.getItemsByUser(id);</span>
<span class="fc" id="L125">    			return new ResponseEntity&lt;&gt;(items, HttpStatus.OK);</span>
<span class="fc" id="L126">			} catch (RuntimeException e) {</span>
<span class="fc" id="L127">				return new ResponseEntity&lt;&gt;(HttpStatus.BAD_REQUEST);</span>
			}
        }
    }
    
	/**
	 * Retrieves all available items in the system using a token for authentication.
	 *
	 * @param token The authentication token.
	 * @return ResponseEntity containing a list of available items.
	 * 
	 *  @GetMapping(&quot;/available&quot;)
    public ResponseEntity&lt;List&lt;Item&gt;&gt; getAvailableItems(@RequestParam(&quot;token&quot;) String token) {
    	User user = userService.getUserByToken(token);
        if (user == null) {
        	return new ResponseEntity&lt;&gt;(new ArrayList&lt;&gt;(),HttpStatus.UNAUTHORIZED);
        }
        List&lt;Item&gt; items = itemService.getItemsByAvailability(Item.ItemStatus.AVAILABLE);
        return new ResponseEntity&lt;&gt;(items, HttpStatus.OK);
    }
	 */
   
    
/**
 * Retrieves an item by its ID.
 *
 * @param id The ID of the item.
 * @return ResponseEntity containing the item.
 */
    @GetMapping(&quot;/{id}&quot;)
	public ResponseEntity&lt;Item&gt; getItemById(@PathVariable Long id) {
<span class="fc" id="L158">		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="fc" id="L159">		String email = authentication.getName();</span>

<span class="fc" id="L161">		User user = userService.getUserByEmail(email);</span>
<span class="fc" id="L162">		Optional&lt;Item&gt; optionalItem = itemService.getItemById(id);</span>

<span class="fc bfc" id="L164" title="All 4 branches covered.">		if (user == null || optionalItem.isEmpty()) {</span>
<span class="fc" id="L165">			return new ResponseEntity&lt;&gt;(HttpStatus.UNAUTHORIZED); // o 404 si prefieres</span>
		}

<span class="fc" id="L168">		Item item = optionalItem.get();</span>

<span class="fc bfc" id="L170" title="All 2 branches covered.">		if (!item.getOwner().equals(user.getId())) { // TODO &amp;&amp; !user.getAdmin()) {</span>
<span class="fc" id="L171">			return new ResponseEntity&lt;&gt;(HttpStatus.FORBIDDEN);</span>
		}

<span class="fc" id="L174">		return new ResponseEntity&lt;&gt;(item, HttpStatus.OK);</span>
	}
    
    /**
     * Retrieves all items lent by the authenticated user.
     *
     * @return ResponseEntity containing a list of lent items.
     */

	@GetMapping(&quot;/lent&quot;)
	public ResponseEntity&lt;List&lt;Item&gt;&gt; getLentItemsByUser() {
		// Obtener el usuario autenticado desde el SecurityContext
<span class="fc" id="L186">		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="fc" id="L187">		String email = authentication.getName(); // Usamos el email como identificador</span>

		// Buscar al usuario por el email
<span class="fc" id="L190">		User user = userService.getUserByEmail(email);</span>
<span class="fc bfc" id="L191" title="All 2 branches covered.">		if (user == null) {</span>
<span class="fc" id="L192">			return new ResponseEntity&lt;&gt;(HttpStatus.UNAUTHORIZED);</span>
		}

		try {
			// Obtener los items que el usuario ha prestado
<span class="fc" id="L197">			List&lt;Long&gt; lentItemsId = loanService.getLentItemsIdByUser(user.getId());</span>
<span class="fc" id="L198">			List&lt;Item&gt; lentItems = itemService.getItemsById(lentItemsId);</span>

<span class="fc" id="L200">			return new ResponseEntity&lt;&gt;(lentItems, HttpStatus.OK);</span>
<span class="fc" id="L201">		} catch (RuntimeException e) {</span>
			// Si ocurre un error, devolvemos un error 500
<span class="fc" id="L203">			return new ResponseEntity&lt;&gt;(HttpStatus.INTERNAL_SERVER_ERROR);</span>
		}
	}

	/**
     * Retrieves all items borrowed by the authenticated user.
     *
     * @return ResponseEntity containing a list of borrowed items.
     */
	@GetMapping(&quot;/borrowed&quot;)
	public ResponseEntity&lt;List&lt;Item&gt;&gt; getBorrowedItemsByUser() {
		// Obtener el usuario autenticado desde el SecurityContext
<span class="fc" id="L215">		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="fc" id="L216">		String email = authentication.getName(); // Usamos el email como identificador</span>

		// Buscar al usuario por el email
<span class="fc" id="L219">		User user = userService.getUserByEmail(email);</span>
<span class="fc bfc" id="L220" title="All 2 branches covered.">		if (user == null) {</span>
<span class="fc" id="L221">			return new ResponseEntity&lt;&gt;(HttpStatus.UNAUTHORIZED);</span>
		}

		try {
			// Obtener los items que el usuario ha prestado
<span class="fc" id="L226">			List&lt;Long&gt; lentItemsId = loanService.getBorrowedItemsIdByUser(user.getId());</span>
<span class="fc" id="L227">			List&lt;Item&gt; lentItems = itemService.getItemsById(lentItemsId);</span>

<span class="fc" id="L229">			return new ResponseEntity&lt;&gt;(lentItems, HttpStatus.OK);</span>
<span class="fc" id="L230">		} catch (RuntimeException e) {</span>
			// Si ocurre un error, devolvemos un error 500
<span class="fc" id="L232">			return new ResponseEntity&lt;&gt;(HttpStatus.INTERNAL_SERVER_ERROR);</span>
		}
	}

	 /**
     * Creates a new item.
     *
     * @param itemRecord The item data.
     * @return ResponseEntity indicating the result of the operation.
     */


    @PostMapping(&quot;/create&quot;)
    public ResponseEntity&lt;String&gt; createItem(@RequestBody ItemRecord itemRecord) {
<span class="fc" id="L246">        User user = getAuthenticatedUser();</span>
<span class="fc bfc" id="L247" title="All 2 branches covered."> 		if (user == null) {</span>
<span class="fc" id="L248"> 			return new ResponseEntity&lt;&gt;(HttpStatus.UNAUTHORIZED);</span>
 		}
 		
<span class="fc" id="L251"> 		Item item = convertToItem(itemRecord);</span>
<span class="fc" id="L252"> 		item.setOwner(user.getId());</span>
 		try {
<span class="fc" id="L254"> 			itemService.saveItem(item);</span>
<span class="fc" id="L255">        } catch (RuntimeException e) {</span>
<span class="fc" id="L256">             return new ResponseEntity&lt;&gt;(e.getMessage(), HttpStatus.BAD_REQUEST);</span>
<span class="fc" id="L257">         }</span>
 		// If the item is created successfully, return a 201 Created response
<span class="fc" id="L259"> 		return new ResponseEntity&lt;&gt;(HttpStatus.CREATED);</span>
    }

	

    /**
     * Creates a new item using a token for authentication.
     *
     * @param itemRecord The item data.
     * @param token      The authentication token.
     * @return ResponseEntity indicating the result of the operation.
     */
	@PostMapping(params = &quot;token&quot;)
     public ResponseEntity&lt;String&gt; createItem(@RequestBody ItemRecord itemRecord, @RequestParam(&quot;token&quot;) String token) {
<span class="fc" id="L273">         User user = userService.getUserByToken(token);</span>
<span class="fc bfc" id="L274" title="All 2 branches covered.">         if (user == null) {</span>
<span class="fc" id="L275">             return new ResponseEntity&lt;&gt;(HttpStatus.UNAUTHORIZED);</span>
         }
<span class="fc" id="L277">         Item item = convertToItem(itemRecord);</span>
<span class="fc" id="L278">         item.setOwner(user.getId());</span>
         try {
<span class="fc" id="L280">             itemService.saveItem(item);</span>
<span class="fc" id="L281">         } catch (RuntimeException e) {</span>
<span class="fc" id="L282">             return new ResponseEntity&lt;&gt;(e.getMessage(), HttpStatus.BAD_REQUEST);</span>
<span class="fc" id="L283">         }</span>
<span class="fc" id="L284">         return new ResponseEntity&lt;&gt;(HttpStatus.CREATED);</span>
     }

	
	 /**
     * Deletes an item by its ID.
     *
     * @param id    The ID of the item.
     * @param token The authentication token.
     * @return ResponseEntity indicating the result of the operation.
     */
	
    @DeleteMapping(&quot;/{id}&quot;)
    public ResponseEntity&lt;String&gt; deleteItem(@PathVariable Long id, @RequestParam(&quot;token&quot;) String token) {
<span class="fc" id="L298">        User user = userService.getUserByToken(token);</span>
<span class="fc bfc" id="L299" title="All 6 branches covered.">        if (user == null || user.getAdmin()==false &amp;&amp; user.getId()!=itemService.getItemById(id).get().getOwner()) {</span>
<span class="fc" id="L300">			return new ResponseEntity&lt;&gt;(HttpStatus.UNAUTHORIZED);</span>
		
        }
    	
<span class="fc" id="L304">    	itemService.deleteItem(id);</span>
<span class="fc" id="L305">    	return new ResponseEntity&lt;&gt;(HttpStatus.OK);</span>
    }
    
    /**
     * Updates an item by its ID.
     *
     * @param id       The ID of the item.
     * @param item     The updated item data.
     * @param token    The authentication token.
     * @return ResponseEntity indicating the result of the operation.
     */
    @PutMapping(&quot;/{id}&quot;)
	public ResponseEntity&lt;String&gt; updateItem(@PathVariable Long id, @RequestBody ItemRecord item, @RequestParam(&quot;token&quot;) String token) {
<span class="fc" id="L318">    	User user = userService.getUserByToken(token);</span>
<span class="fc bfc" id="L319" title="All 6 branches covered.">		if (user == null || user.getId()!=Long.valueOf(itemService.getItemById(id).get().getOwner()) &amp;&amp; user.getAdmin()!=true) {</span>
<span class="fc" id="L320">			return new ResponseEntity&lt;&gt;(HttpStatus.UNAUTHORIZED);</span>
		}
		
    	try {
<span class="fc" id="L324">    		Item itemToModify = itemService.getItemById(id).get();</span>
<span class="fc bfc" id="L325" title="All 2 branches covered.">			itemToModify.setName(item.name() == null ? itemToModify.getName() : item.name() );</span>
<span class="fc bfc" id="L326" title="All 2 branches covered.">			itemToModify.setDescription(item.description() == null ? itemToModify.getDescription() : item.description() );</span>
<span class="fc bfc" id="L327" title="All 2 branches covered.">			itemToModify.setCategory(item.category() == null ? itemToModify.getCategory() : item.category());</span>
<span class="fc bfc" id="L328" title="All 2 branches covered.">			itemToModify.setImage(item.imageUrl() == null ? itemToModify.getImage() : item.imageUrl());</span>
<span class="fc bfc" id="L329" title="All 2 branches covered.">			itemToModify.setStatus(Item.ItemStatus.valueOf(item.status()==null ? itemToModify.getStatus().toString() : item.status()));</span>
<span class="fc bfc" id="L330" title="All 2 branches covered.">			itemToModify.setCondition(Item.ItemCondition.valueOf(item.condition()==null ? itemToModify.getCondition().toString() : item.condition()));</span>
<span class="fc" id="L331">			itemService.saveItem(itemToModify);</span>
<span class="fc" id="L332">			return new ResponseEntity&lt;&gt;(HttpStatus.OK);</span>
<span class="fc" id="L333">		} catch (RuntimeException e) {</span>
<span class="fc" id="L334">			return new ResponseEntity&lt;&gt;(e.getMessage(),HttpStatus.NOT_FOUND);</span>
		}
	}

    /**
     * Converts an ItemRecord to an Item entity.
     *
     * @param itemRecord The item record.
     * @return The converted Item entity.
     */
    private Item convertToItem(ItemRecord itemRecord) {
<span class="fc" id="L345">		Item item = new Item();</span>
<span class="fc" id="L346">		item.setName(itemRecord.name());</span>
<span class="fc" id="L347">		item.setDescription(itemRecord.description());</span>
<span class="fc" id="L348">		item.setCategory(itemRecord.category());</span>
<span class="fc" id="L349">		item.setImage(itemRecord.imageUrl());</span>
<span class="fc" id="L350">		item.setStatus(Item.ItemStatus.valueOf(itemRecord.status().toUpperCase()));</span>
<span class="fc" id="L351">		item.setPurchaseDate(new java.util.Date());</span>
<span class="fc" id="L352">		item.setPurchasePrice(0.0);</span>
<span class="fc" id="L353">		item.setCondition(Item.ItemCondition.NEW);</span>
<span class="fc" id="L354">		return item;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>